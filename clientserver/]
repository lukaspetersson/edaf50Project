/* myclient.cc: sample client program */
#include "connection.h"
#include "connectionclosedexception.h"
#include "Protocol.h"

#include <cstdlib>
#include <iostream>
#include <stdexcept>
#include <string>

using namespace std;

void write(const Connection& conn, int com_num){
	//write commandbyte
	conn.write(com_num & 0xFF);
	//write parameter
	switch(com_num) {
		case static_cast<int>(Protocol::COM_LIST_NG):
		     //list newsgroups
		     //no parameters
		break;
		case static_cast<int>(Protocol::COM_CREATE_NG):
		    //create new newsgroup
		    //parameter: string title
		    string title;
		    getline(cin, title);
		    writeString(conn, title);
		break;
		case static_cast<int>(Protocol::COM_DELETE_NG):
		    //delete newsgroup
		    //parameter: int ID
		    int id;
		    cin >> id;
		    writeNumber(id);
		break;
		case static_cast<int>(Protocol::COM_LIST_ART):
		    //list articles
		    //parameter: int ID
		    int id;
		    cin >> id;
		    writeNumber(id);
		break;
		case static_cast<int>(Protocol::COM_CREATE_ART):
		    //create article
		    //parameters: int ID, string title, string author, string text
		    int id;
		    cin >> id;
		    writeNumber(id);
		    string line;
		    getline(cin, line);
		    writeString(conn, line);
		    getline(cin, title);
		    writeString(conn, line);
		    getline(cin, line);
		    writeString(conn,line);
		break;
		case static_cast<int>(Protocol::COM_DELETE_ART):
		    //delete article
		    //parameters: int ID, int ID
		    int id;
		    cin >> id;
		    writeNumber(id);
		    cin >> id;
		    writeNumber(id);
		break;
		case static_cast<int>(Protocol::COM_GET_ART):
		    //get article
		    //parameters: int ID, int ID
		    int id;
		    cin >> id;
		    writeNumber(id);
		    cin >> id;
		    writeNumber(id);
		break;
	}
	//write endbyte
	conn.write(static_cast<int>(Protocol::COM_END) & 0xFF);

}

// write string_p
void writeString(const Connection& conn, string s){
	    conn.write(static_cast<int>(Protocol::PAR_STRING));
	    int len = s.size();
            conn.write((len >> 24) & 0xFF);
            conn.write((len >> 16) & 0xFF);
	    conn.write((len >> 8) & 0xFF);
	    conn.write(len & 0xFF);
	    for(char c : s)conn.write(c);
}

// write num_p
void writeNumber(const Connection& conn, int value){
	conn.write(static_cast<int>(Protocol::PAR_NUM));
        conn.write((value >> 24) & 0xFF);
        conn.write((value >> 16) & 0xFF);
        conn.write((value >> 8) & 0xFF);
        conn.write(value & 0xFF);
}

void read(const Connection& conn){
	char ans_num{conn.read()};
	switch(ans_num) {
		case static_cast<int>(Protocol::ANS_LIST_NG):
			int num_ng = readNumber(conn);
			for(int i = 0; i != num_ng; i++){
				int id = readNumber(conn);
				string title = readNumber(conn);
				cout<<"ID: "<<id<<", TITLE: "<<title<<endl;
			}	
		break;
		case static_cast<int>(Protocol::ANS_CREATE_NG):
			unsigned char ans = conn.read();
			if(ans == static_cast<int>(Protocol::ANS_ACK)){ 
				cout<<"News group added"<<endl;
			}else if(ans == static_cast<int>(Protocol::ANS_NAK)){
				printError(conn);
			}
		break;
		case static_cast<int>(Protocol::ANS_DELETE_NG):
			unsigned char ans = conn.read();
			if(ans == static_cast<int>(Protocol::ANS_ACK)){ 
				cout<<"News group deleted"<<endl;
			}else if(ans == static_cast<int>(Protocol::ANS_NAK)){
				printError(conn);
			}
		break;
		case static_cast<int>(Protocol::ANS_LIST_ART):
			unsigned char ans = conn.read();
			if(ans == static_cast<int>(Protocol::ANS_ACK)){ 
				int num_art = readNumber(conn);
				for(int i = 0; i != num_art; i++){
					int id = readNumber(conn);
					string title = readNumber(conn);
					cout<<"ID: "<<id<<", TITLE: "<<title<<endl;
				}	
			}else if(ans == static_cast<int>(Protocol::ANS_NAK)){
				printError(conn);
			}
		break;
		case static_cast<int>(Protocol::ANS_CREATE_ART):
			unsigned char ans = conn.read();
			if(ans == static_cast<int>(Protocol::ANS_ACK)){ 
				cout<<"Article added"<<endl;
			}else if(ans == static_cast<int>(Protocol::ANS_NAK)){
				printError(conn);
			}
		break;
		case static_cast<int>(Protocol::ANS_DELETE_ART):
			unsigned char ans = conn.read();
			if(ans == static_cast<int>(Protocol::ANS_ACK)){ 
				cout<<"Article deleted"<<endl;
			}else if(ans == static_cast<int>(Protocol::ANS_NAK)){
				printError(conn);
			}
		break;
		case static_cast<int>(Protocol::ANS_GET_ART:
			unsigned char ans = conn.read();
			if(ans == static_cast<int>(Protocol::ANS_ACK)){ 
				string title = readString(conn);
				string author = readString(conn);
				string text = readString(conn);
				cout<<"TITLE: "<<title<<endl<<"AUTHOR: "<<author<<endl<<text<<endl;
			}else if(ans == static_cast<int>(Protocol::ANS_NAK)){
				printError(conn);
			}
		break;
	}
	//remove ANS_END
	conn.read();
}

void printError(const Connection& conn){
	cout<<"ERROR: ";
        unsigned char err = conn.read();
	switch(err):
		case static_cast<int>(Protocol::ERR_NG_ALREADY_EXISTS):
			cout<<"News group already exists"<<endl;
		break;
		case static_cast<int>(Protocol::ERR_NG_DOES_NOT_EXIST):
			cout<<"News group does not exist"<<endl;
		break;
		case static_cast<int>(Protocol::ERR_ART_DOES_NOT_EXIST):
			cout<<"Article does not exist"<<endl;
}

//read num_p
int readNumber(const Connection& conn){
	//remove PAR_NUM
	conn.read();

	//read number
        unsigned char byte1 = conn.read();
        unsigned char byte2 = conn.read();
        unsigned char byte3 = conn.read();
        unsigned char byte4 = conn.read();
        return (byte1 << 24) | (byte2 << 16) | (byte3 << 8) | byte4;
}

//read string_p
string readString(const Connection& conn){
	//remove PAR_STRING
	conn.read();

        string s;
        char   c;
        while ((c = conn.read()) != '$') {
                s += c;
        }
        return s;
}

/* Creates a client for the given args, if possible.
 * Otherwise exits with error code.
 */
Connection init(int argc, char* argv[])
{
        if (argc != 3) {
                cerr << "Usage: myclient host-name port-number" << endl;
                exit(1);
        }

        int port = -1;
        try {
                port = stoi(argv[2]);
        } catch (exception& e) {
                cerr << "Wrong port number. " << e.what() << endl;
                exit(2);
        }

        Connection conn(argv[1], port);
        if (!conn.isConnected()) {
                cerr << "Connection attempt failed" << endl;
                exit(3);
        }

        return conn;
}

int app(const Connection& conn){
        cout << "Type the number for the desired action: ";
        int nbr;
        while (cin >> nbr) {
                try {
                        write(conn, nbr);
			read();
                        cout << "Type another number: ";
                } catch (ConnectionClosedException&) {
                        cout << " no reply from server. Exiting." << endl;
                        return 1;
                }
        }
        cout << "\nexiting.\n";
        return 0;
}

int main(int argc, char* argv[])
{
        Connection conn = init(argc, argv);
        return app(conn);
}
